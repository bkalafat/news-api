name: Keep Backend Alive (Azure Container Apps)

on:
  schedule:
    # Azure Container Apps scale-to-zero destekliyor
    # Sadece haftalƒ±k news aggregation √∂ncesi warm-up i√ßin √ßalƒ±≈üsƒ±n
    # Pazartesi sabah 04:00 TR (01:00 UTC) - aggregation'dan 1 saat √∂nce
    - cron: '0 1 * * 1'  # Weekly Monday 04:00 TR
  
  workflow_dispatch: # Manuel √ßalƒ±≈ütƒ±rma i√ßin

jobs:
  warmup-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: üî• Warm up Azure Container App
        run: |
          echo "Warming up backend before weekly aggregation at $(date -u)"
          
          # Get backend URL from Azure (will be set as secret)
          BACKEND_URL="${{ secrets.AZURE_BACKEND_URL }}"
          
          # Health check
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://$BACKEND_URL/health)
          
          if [ "$RESPONSE" -eq 200 ]; then
            echo "‚úÖ Backend is healthy (HTTP $RESPONSE)"
          else
            echo "‚ö†Ô∏è Backend returned HTTP $RESPONSE"
          fi
      
      - name: üìä Verify API endpoint
        run: |
          echo "Verifying API endpoint..."
          BACKEND_URL="${{ secrets.AZURE_BACKEND_URL }}"
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://$BACKEND_URL/api/NewsArticle)
          
          if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 401 ]; then
            echo "‚úÖ API is responding (HTTP $RESPONSE)"
          else
            echo "‚ö†Ô∏è API returned HTTP $RESPONSE"
          fi

# Azure Container Apps Free Tier Benefits:
# - Scale to zero when idle (saves resources)
# - 2M requests/month free
# - Only warm up weekly before news aggregation (99% reduction in keep-alive pings)
# - Cold start ~2-3 seconds (acceptable for weekly batch job)
